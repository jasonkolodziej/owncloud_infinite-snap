#!/bin/bash -e
#? Reference: https://snapcraft.io/docs/adding-snap-configuration#heading--interpreting

CONFIG_FILE_LOCATION="$OCIS_CONFIG_DIR/ocis.yaml"
CONFIG_FILE_LOCATION="../../ocis/config/ocis.example.yaml"

# export NEXTCLOUD_CONFIG_DIR="$SNAP_DATA/nextcloud/config"
# export NEXTCLOUD_DATA_DIR="$SNAP_COMMON/nextcloud/data"

#* PRIVATE_KEY_TERMS
#*   *secret* *password* *key*

_not_private_key_terms() {
    # yq '[... | { "p": path | join("."), "isKey": is_key, "tag": tag, "value": eval(path) } | select(.p != "*secret*") | select(.p != "*key*") | select(.p!= "*password*") | select(.tag != "!!map") | select(.isKey == false) ]' ${CONFIG_FILE_LOCATION}
    non_priv=$(yq '[... | { "p": path | join("."), "isKey": is_key, "tag": tag, "value": eval(path) } | select(.p != "*secret*") | select(.p != "*key*") | select(.p!= "*password*") | select(.tag != "!!map") | select(.isKey == false) | { .p:.value } ]' ${CONFIG_FILE_LOCATION} | tr -d '-' | tr ':' '=' | tr -d ' ')
    # non_priv=$(echo -e $non_priv | tr -d '-' | tr ':' '=' | tr -d ' ')
    for line in $non_priv; do
        echo -e "$line"
    done
    # echo $non_priv
}

_private_key_terms() {
    # yq '[... | { "p": path | join("."), "isKey": is_key, "tag": tag, "value": eval(path) } | select(.p != "*secret*") | select(.p != "*key*") | select(.p!= "*password*") | select(.tag != "!!map") | select(.isKey == false) ]' ${CONFIG_FILE_LOCATION}
    secrets=$(yq '[... | { "p": path | join("."), "isKey": is_key, "tag": tag, "value": eval(path) } | select(.p == "*secret*") | select(.tag != "!!map") | select(.isKey == false) | { .p:.value }]' ${CONFIG_FILE_LOCATION})
    keys=$(yq '[... | { "p": path | join("."), "isKey": is_key, "tag": tag, "value": eval(path) } | select(.p == "*key*") | select(.tag != "!!map") | select(.isKey == false) | { .p:.value } ]' ${CONFIG_FILE_LOCATION})
    passwords=$(yq '[... | { "p": path | join("."), "isKey": is_key, "tag": tag, "value": eval(path) } | select(.p == "*password*") | select(.tag != "!!map") | select(.isKey == false) | { .p:.value } ]' ${CONFIG_FILE_LOCATION})
    #* clean up ==> | tr -d  '-' | tr ':' '=' | tr -d ' '
    privs=$(echo "${secrets[@]} \n ${keys[@]} \n ${passwords[@]}" | tr -d '-' | tr ':' '=' | tr -d ' ')
    for line in $privs; do
        echo -e "$line"
    done
    # echo "${secrets[@]} \n ${keys[@]} \n ${passwords[@]}"

}

trim_iterator() {
    ins=$(${1} | tr -d '-' | tr ':' '=' | tr -d ' ')
    for line in $ins; do
        echo -e "$line"
    done
}

#* Set Config - sets the value/values of the config
set_config() {
    local arrIN=(${1//=/ })
    local param=${arrIN[0]}
    local val=${arrIN[1]}

    #echo $param
    #echo $val
    echo "setting ${param}=\"$val"\"
    snapctl set ${param}="$val"
    # snapctl set ${1}="$2"
}

_update_yaml_inplace() {
    local updater="$@"
    yq -i ".$updater" ${CONFIG_FILE_LOCATION}
}

_update_yaml() {
    local updater="$@"
    yq ".$updater" ${CONFIG_FILE_LOCATION}
}

_json_to_yaml() {
    # yq -Poy sample.json
    yq -Poy sample.json
}

#* Get Config - requests the default config's value if nothing is yet set and returns the value
get_config() {
    local conf_key=${1}
    # local config_option=

    # if [ -n "$conf_key" ]; then
    # local config_option="$(snapctl get ${conf_key})"
    # fi
    if [ -z "$config_option" ]; then
        config_option="$(yq ".${conf_key}" ${CONFIG_FILE_LOCATION})"
    fi
    # yq ".${1}" ${CONFIG_FILE_LOCATION}
    echo "$config_option"
}

# TODO: fix
handle_config() {
    echo 'handle_config params' $@
    local some_config="$(get_config)"
    # Validate HTTP port
    #        if ! expr "$some_config" : '^[0-9]\+$' > /dev/null; then
    #               echo "\"$some_config\" is not a valid HTTP port" >&2
    #              return 1
    #     fi
    # run function from management script
    set_config "$some_config"

    # Restart example-server to apply new config
    # snapctl restart example-server
}

# handle_config

_private_key_terms
_not_private_key_terms
# _update_yaml $@
