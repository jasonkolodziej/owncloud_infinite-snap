#!/bin/sh -e
#? When running ocis init, a random admin password will be printed to the shell for first login.
#? Though the password can be changed afterwards in the UI, it is possible to define it right from the start when initializing.
#* --insecure
#* OCIS_INSECURE, value=true|false
#? This allows to use transport security, but disables certificate verification.
#? Useful with self-signed certificates to avoid certificate warnings.
#? If set, the value will also be written to the config file. In such a case, when calling `ocis server`,
#? it is not necessary to set the environment variable again with each start.
#* --config-path
#* OCIS_CONFIG_DIR, value=absolute_path
#? If using this setting, the environment variable MUST be used when starting `ocis server`.
#* --force-overwrite or -f
#* OCIS_FORCE_CONFIG_OVERWRITE, value=true|false
#? If you already have run `ocis init` and a config has been defined, a consecutive run will cause a warning
#? that a config already exists. Use this if you want to create a new configuration.

# OCIS_INSECURE=false \
#     IDM_ADMIN_PASSWORD=changeme \
#     ocis init

DEFAULT_OCIS_CONFIG_FILE_LOCATION="$OCIS_CONFIG_DIR/ocis.yaml"

#? On Ubuntu Core, a deviceâ€™s gadget snap can share default configuration options with the snaps listed in its gadget.yaml.
#? These options are shared when a snap is first installed using either the default-configure hook,
#? which is run before services are started, or with the configure hook, which runs after services are started.

#? defined generated certs...
# OCIS_INSECURE=false
# PROXY_TRANSPORT_TLS_KEY=./certs/your-host.key
# PROXY_TRANSPORT_TLS_CERT=./certs/your-host.crt
#? auto certs
TEMP_OCIS_INSECURE='true'
# PROXY_HTTP_ADDR=0.0.0.0:9200
# OCIS_URL=https://your-host:9200
TEMP_IDM_ADMIN_PW='changeme'

#? if the default exec config hasn't been created
[ -e "$DEFAULT_OCIS_CONFIG_FILE_LOCATION" ] || touch $DEFAULT_OCIS_CONFIG_FILE_LOCATION

snapctl set-health okay

exec "$SNAP/bin/ocis init" --config-path="${DEFAULT_OCIS_CONFIG_FILE_LOCATION}" --ap="${TEMP_IDM_ADMIN_PW}" --insecure="${TEMP_OCIS_INSECURE}"

# snapctl restart ocis
