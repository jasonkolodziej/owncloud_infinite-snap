#!/bin/sh -e
#? When running ocis init, a random admin password will be printed to the shell for first login.
#? Though the password can be changed afterwards in the UI, it is possible to define it right from the start when initializing.
#* --insecure
#* OCIS_INSECURE, value=true|false
#? This allows to use transport security, but disables certificate verification.
#? Useful with self-signed certificates to avoid certificate warnings.
#? If set, the value will also be written to the config file. In such a case, when calling `ocis server`,
#? it is not necessary to set the environment variable again with each start.
#* --config-path
#* OCIS_CONFIG_DIR, value=absolute_path
#? If using this setting, the environment variable MUST be used when starting `ocis server`.
#* --force-overwrite or -f
#* OCIS_FORCE_CONFIG_OVERWRITE, value=true|false
#? If you already have run `ocis init` and a config has been defined, a consecutive run will cause a warning
#? that a config already exists. Use this if you want to create a new configuration.

# OCIS_INSECURE=false \
#     IDM_ADMIN_PASSWORD=changeme \
#     ocis init

D_OCIS_CONFIG_FILE_LOCATION="$OCIS_CONFIG_DIR/ocis.yaml"

#? defined generated certs...
# OCIS_INSECURE=false
# PROXY_TRANSPORT_TLS_KEY=./certs/your-host.key
# PROXY_TRANSPORT_TLS_CERT=./certs/your-host.crt
#? auto certs
D_OCIS_INSECURE='true'
# PROXY_HTTP_ADDR=0.0.0.0:9200
# OCIS_URL=https://your-host:9200
D_IDM_ADMIN_PASSWORD='changeme'

file_created="$(touch ${D_OCIS_CONFIG_FILE_LOCATION})"

if ! [ -f "$D_OCIS_CONFIG_FILE_LOCATION" ]; then
    snapctl set-health blocked "$(whoami): there was an error touching the file"
fi

get_basics() {
    local insecure="$(snapctl get $SNAP_NAME insecure)"
    if [ -z "$insecure" ]; then #? z, string is null, that is, has zero length
        insecure="$(yq ".insecure" ${CONFIG_FILE_LOCATION})"
    fi
    if [ -z "$insecure" ]; then #? z, string is null, that is, has zero length
        snapctl set $SNAP_NAME insecure="${D_OCIS_INSECURE}"
    fi

    local idm_adminpass="$(snapctl get $SNAP_NAME private.idm.service-user-passwords.admin-password)"
    if [ -z "$idm_adminpass" ]; then #? z, string is null, that is, has zero length
        idm_adminpass="$(yq ".idm.service_user_passwords.admin_password" ${CONFIG_FILE_LOCATION})"
    fi
    if [ -z "$idm_adminpass" ]; then #? z, string is null, that is, has zero length
        snapctl set $SNAP_NAME private.idm.service-user-passwords.admin-password="${D_IDM_ADMIN_PASSWORD}"
    fi
}
c_insecure="$(snapctl get $SNAP_NAME insecure)"
c_idm_adminpass="$(snapctl get $SNAP_NAME private.idm.service-user-passwords.admin-password)"

OCIS_INSECURE=${c_insecure} \
IDM_ADMIN_PASSWORD=${c_idm_adminpass} \
$SNAP/usr/bin/ocis init

#? Note that this will bind ocis to the shell you are running.
#? If you want to detach it and avoid it being stopped when closing the shell or
#? the shell gets disconnected (SIGHUP), use the following command:
#* ocis server & disown -h
